//* It doesn't wok!

import puppeteer, { Browser as BrowserInterface, Page as PageInterface } from "puppeteer";

import { sessionFactory } from "../factories/sessionFactory";
import { userFactory } from "../factories/userFactory";
import { IUserModel } from "../../models/UserModel";

export default class CustomPage {
  page: PageInterface;

  //* V1
  // static async build() {
  //   const browser = (await puppeteer.launch({
  //     headless: false,
  //     // args: ["--no-sandbox"],
  //   })) as BrowserInterface;

  //   const page = await browser.newPage();
  //   const customPage = new CustomPage(page);

  //   return new Proxy(customPage, {
  //     get: function (_target, property) {
  //       return (
  //         customPage[property as keyof CustomPage] ||
  //         browser[property as keyof BrowserInterface] ||
  //         page[property as keyof PageInterface]
  //       );
  //     },
  //   });
  // }

  //* V2
  static async build() {
    const browser = (await puppeteer.launch({
      headless: false,
    })) as BrowserInterface;

    const page = await browser.newPage();
    const customPage = new CustomPage(page);

    return (
      new Proxy(customPage, {
        get(target, property, receiver) {
          if (target[property as keyof CustomPage]) {
            return target[property as keyof CustomPage];
          }

          const value = (page as any)[property];
          if (value instanceof Function) {
            return function (this: any, ...args: any) {
              return value.apply(this === receiver ? page : this, args);
            };
          }

          return value;
        },
      }) instanceof CustomPage && page
    );
  }

  constructor(page: PageInterface) {
    this.page = page;
  }

  async login() {
    const user = await userFactory();
    // console.log("user:", user);
    const { sessionString, cookieSig } = await sessionFactory(user as IUserModel);
    // console.log({ sessionString, cookieSig });

    await this.page.setCookie({ name: "session", value: sessionString });
    await this.page.setCookie({ name: "session.sig", value: cookieSig });
    await this.page.goto("http://localhost:3000");
    await this.page.waitForSelector('a[href="/auth/logout"]');
  }
}

//* export default class CustomPage above!
// export default CustomPage;
